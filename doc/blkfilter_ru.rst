.. SPDX-License-Identifier: GPL-2.0

================================================
Механизм фильтрации блочных устройств
================================================

Механизм фильтрации блочных устройств — это API, которое позволяет подключать фильтры блочных устройств.
Фильтры блочных устройств позволяют выполнить дополнительную обработку запросов ввода/вывода.

Introduction
============

Идея перехвата запросов к блочным устройствам не новая.
Ещё в ядре 2.6 существовала недокументированная возможность перехвата запросов с помощью подмены функции make_request_fn, которая принадлежала структуре request_queue.
Ни один модуль ядра не использовал эту возможность, и в ядре 5.10 она была устранена.

Механизм фильтрации блочных устройств возвращает возможность перехвата запросов ввода/вывода.
Предусматривается возможность безопасно подключить один фильтр к блочному устройству "на лету" без изменения структуры блочных устройств.

Design
======

Механизм фильтрации блочных устройств предоставляет функции для подключения и отключения фильтра.
Фильтр представляет собой структуру со счётчиком ссылок и функциями для обратного вызова.

Функция обратного вызова submit_bio_cb() вызывается для каждого запроса ввода/вывода для блочного устройства, обеспечивая фильтрацию запросов.
В зависимости от результата обработки запроса ввода/вывода фильтром запрос может быть либо пропущен для последующей обработки блочным слоем, либо нет.

Счётчик ссылок позволяет контролировать время жизни фильтра.
Когда счётчик ссылок уменьшается до нуля, вызывается функция обратного вызова detach_cb() для освобождения фильтра.
Это позволяет освобождать фильтр при отключении блочного устройства.
