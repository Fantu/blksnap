# blksnap - модуль для создания снапшотов блочных устройств

## Введение
В идеи создания снапшотов для блочных устройств нет новизны. Даже в ядре Linux уже есть механизмы для создания снапшотов блочных устройств.
Прежде всего это Device Mapper, который позволяет создавать персистентные и неперсистентные снапшоты блочных устройств. Есть файловые системы, поддерживающие снапшоты, такие как BTRFS. Есть и другие, но у всех них есть свои особенности. Эти особенности не позволяют использовать их как универсальное средство для создание резервных копий. Именно поэтому разные поставщики средств для резервного копирования предлагают для создания снапшотов свои модули ядра. К сожалению ни один из этих модулей не соответствует требованиям восходящего потока ядра Linux.
Модуль blksnap создавался именно с целью предложения его в восходящий поток. Он обеспечивает создание неперсистентных снапшотов на большинстве современных систем без требования изменения их конфигурации.

## Возможности модуля blksnap
В модуле реализован трекер изменений. Он позволяет определить, какие  блоки были изменены за время между последним созданным снапшотом и любым из предыдущих снапшотов одного поколения. Это позволяет реализовывать логику как инкрементального, так и дифференциального бэкапа.

Для хранения изменений снапшота может быть использован произвольный диапазон секторов на любом блочном устройстве. Размер хранилища изменений может увеличиваться уже после создания снапшота путём добавления новых диапазонов секторов. Это позволяет создавать хранилище изменений в отдельных файлах на файловой системе, которая может занимать всё пространство блочного устройства и увеличивать хранилище изменений по мере необходимости.

Для создания образов снапшотов блочных устройств модуль хранит блоки оригинального блочного устройства, которые были изменены с момента снятия снапшота. Для этого модуль перехватывает запросы на запись и считывает блоки, которые должны быть перезаписаны. Такой алгоритм гарантирует сохранность данных оригинального блочного устройства в случае переполнения снапшота и даже в случае непредсказуемых критических ошибкок.

Снапшот создаётся одновременно для нескольких блочных устройств, обеспечивая их согласованное состояние в резервной копии.

Снапшот создаётся именно для блочного устройства, а не для состояния файловой системы. Это позволяет использовать его для случаев, когда блочное устройство используется без файловой системы, файловая система не поддерживается или поддерживается не полностью.

Перечисленный набор возможностей позволяет использовать его для целей резервного копирования и репликации всего содержимого дисковой подсистемы целиком. В результате значительно упрощается восстановление системы из резервной копии.

Кроме самого модуля ядра, был разработан набор сопутствующего ПО под лицензией GPL и LGPL.
Консольный инструмент и С++ библиотека для управления модулем могут быть использованы для интеграции с другими проектами.
Набор тестов позволит провести регрессионное тестирование после изменений модуля после исправлений ошибок или после добавления новых возможностей.
Разрабатываемая документация призвана сделать изучение модуля более комфортным.

## Как это работает

## Алгоритм перехвата запроса ввода/вывода

## Алгоритм трекера изменений

## Алгоритм добавления областей для храниения изменений

## Как этим пользоваться

## Что дальше
