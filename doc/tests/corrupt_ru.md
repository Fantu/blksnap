# Тест corrupt

## Назначение
Тест предназначен для выявления искажений данных на образе снапшота блочного устройства.
Несколько основных причин, по которым образ снапшота может содержать неверные данные:
* не работает трекинг, то есть запросы не перехватываются;
* неверно работает алгоритм COW, то есть в хранилище изменений попадают уже изменённые данные;
* ошибки в адресации блоков данных.

## Методика тестирования
На блочное устройство производится запись данных определённого паттерна до создания снапшота и после.
После создания снапшота производится проверка данных на образе снапшота. На нём должны быть только данные, записанные до создания снапшота.
Паттерн имеет размер сектора и  представляет собой заголовок и данные случайного характера.
В заголовке контрольная сумма сектора, порядковый номер записи, смещение сектора от начала блочного устройства в секторах, и время записи сектора.
Тот факт что сектор был записан до создания снапшота проверяется по порядковому номеру записи и времени записи.
Корректное расположение сектора проверяется по его его смещению от начала блочного устройства.
Целостность сектора контролируется контрольной суммой.

## Алгоритм
1. Производится заполнение всего оригинального блочного устройства паттерном.
2. Далее действия выполняются в основном тестовом цикле.
3. Создатся снапшот блочного утсройства.
4. Производится полная проверка, что образ снапшота содержит корректные данные.
5. Перезаписывается несколько (3) первых сектора (имитируется обновление суперблока файловой системы при монтировании).
6. В цикле производится запись данных на оригинальное блочное утсройство и проверка данных на снапшоте.
	* Произодится запись случайного количества секторов оригинального блочного устройства.
	* Снова перезапись первого сектора на оригинальном блочном устройстве.
	* Выполняется повторная полная проверка корректности данных на образе снапшота.
	* Если были выявлены повреждения данных на образе снапшота, то первые несколько десятков повреждений логируются.
7. Выводится сообщение об успешности цикла.
8. Снапшот освобождается
9. В случае успеха цикл проверки повторяется, пока не пройдёт выделенное для тестирования время.
