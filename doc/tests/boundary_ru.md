# Тест boundary

## Назначение
Тест предназначен для выявления искажений данных на образе снапшота блочного устройства при перезаписи специфичных секторов, расположенных в начале блочного устройства, или в конце, или на границе блока (куска), которыми оперирует алгоритм COW.

## Методика тестирования
На блочное устройство производится запись данных определённого паттерна по специфичным адресам.
В ходе теста производится запись минимально доступными блоками (512 или 4096 или иные в зависимости от параметра теста).
При этом производится проверка что соседние сектора не изменили своего значения.
Особенность работы модуля blksnap в том, что он производит копирование данных в хранилище изменений кусками (chunk).
Тест проверяет что алгоритм вычисления смещения копируемых кусков выполняется верно.
Как и для тестов "corrupt" и "diff_storage" корректное расположение сектора проверяется по его смещению от начала блочного устройства, время записи по timestamp и sequense number, а целостность сектора контролируется контрольной суммой.
При генерации случайных номеров кусков для проверки учитывается история предыдущих тестов. Это позволяет не выбирать уже проверенные или соседние с ними куски.

## Алгоритм
1. Производится заполнение всего оригинального блочного устройства паттерном.
2. Далее действия выполняются в основном тестовом цикле.
3. Производится проверка записи в оригинальное устройство
	* Создаётся снапшот
	* В цикле
		* Выбирается случайным образом номер куска
		* производится запись первого блока куска на оригинальном устройстве
		* производится проверка остальных блоков куска на оригинальном устройстве
		* производится проверка данных на образе снапшота
			* одного случайного блока куска
			* блока перед тестовым куском
			* блока последующего после тестового куска
		* производится запись последнего блока куска на оригинальном устройстве
		* производится проверка блоков куска на оригинальном устройстве кроме первого и последнего
		* производится проверка на образе снапшота
			* одного случайного блока куска
			* блока перед тестовым куском
			* блока последующего после тестового куска
		* производится проверка на оригинальном блочном устройстве
			* первого блока тестового куска
			* последнего блока тестового куска
	* цикл завершается, снапшот освобождается
4. Производится проверка записи в устройство образа снапшота
	* Создаётся снапшот
	* В цикле
		* Выбирается случайным образом номер куска
		* производится запись первого блока куска на образе снапшота
		* производится проверка на образе снапшота
			* остальных блоков куска
			* последнего блока предыдущего куска
			* первого блока следующего куска
		* производится запись последнего блока куска на образе снапшота
		* производится проверка на образе снапшота
			* всех блоков куска кроме первого и последнего
			* последнего блока предыдущего куска
			* первого блока следующего куска
			* первого блока перезаписанного куска
			* последнего блока перезаписанного куска
	* цикл завершается, снапшот освобождается
5. Производится проверка записи в устройство образа снапшота
	* Создаётся снапшот
	* В цикле
		* Выбирается случайным образом номер куска
		* выполняется запись на границе кусков (два блока: последний одного и первый следующего)
		* производится проверка на образе снапшота
			* блоков первого куска
			* блоков второго куска
			* ранее перезаписанных блоков
	* цикл завершается, снапшот освобождается
6. В случае успеха цикл проверки повторяется, пока не пройдёт выделенное для тестирования время.
