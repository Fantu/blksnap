# Что-то не так со снапшотами для Linux

Всем привет!
Hi all!

Казалось бы, cнапшоты уже давно есть в Linux. Есть Device Mapper и его [снапшоты](https://docs.kernel.org/admin-guide/device-mapper/snapshot.html). Есть BTRFS с поддержкой [снапшотов](https://lwn.net/Articles/579009/). Зачем же разработчик популярного средства резервного копирования предлагает ["новый велосипед"](https://lore.kernel.org/linux-block/20221209142331.26395-1-sergei.shtepa@veeam.com/)? Предлагаю разобраться в причинах.

Для этого давайте взглянем на проблему глазами разработчика средств резевного копирования. Причём средств резевного копирования, ориентированного на корпоративного пользователя. Для начала попробуем понять чем "корпоративный пользователь" отличается от "домашнего пользователя".

## Особенность корпоративного пользователя


Предположим на вашем ПК сломался HDD or SSD. Для восстановления системы на новый SSD вы установите свежую версию любимого дистрибутива, добавите только самые необходимые приложения (остальное установите по мере необходимости), возможно воспользуетесь любимыми скрипами для настройки конфиграции. После этого восстановите из архива данные из раздела /home/. Если вдруг новая система работает несколько иначе - уверен вы быстро найдёт проблему и исправите её. В данном случае, для восстановления работоспособности вам достаточно файлового бэкапа уникальных личных данных на NAS, в лучшем случае на Cloud репозиторий. Вы типичный домашний пользователь.

Предположим что вы руководитель предприятия. И в сети вашего предприятия появился вирус-шифровальшик, или стихийное бедствие вроде пожара или цунами физически уничтожило ваш датацентр. Вся инфраструктура поражена, но бэкап-репозиторий уцелел, так как был изолирован от общей сети и располагался в более защищённом месте (в соседнем городе, стране, или даже на орбитальном датацентре). В этом случае всю инфраструктуру предприятия требуется восстановить в кратчайшие сроки, так как каждый час простоя приносит колоссальные убытки. Поэтому у вас нет времени ждать, пока системные администраторы установят ОС, установят требуемые приложения и произведут необходимую конфигурацию каждого сервера. Нужно вернуть состояние всей инфраструктуры на момент "когда всё работало", причём в кратчайшие сроки. Поэтому файловый бэкап вас не устраивает. Вам нужен бэкап "Entire machine". Вы типичный корпоративный пользователь.

А теперь попробуем ответить на вопрос: "Что требует корпоративный пользователь от средства резервного копирования?".

## Требования к средству резервного копирования

### Универсальность

Разные предприятия выбирают разные схемы организации своей IT инфраструктуры. Даже одно и тоже предприятие в ходе своего развития может менять свою стратегию в этом вопросе. В результате приходится поддерживать огромный зоопарк разных конфигураций IT инфраструктур. Популярны виртуальные машины на ESX-ах или Hyper-V. Может применяться виртуализация на основе Qemu+KVM. Не забываем про XEN. Часто встречаются просто сервера без виртуализации, хотя лет 15 назад некоторые люди полагали, что такие конфигурации вымрут как динозавры. Не вымерли. Живут десятилетиями. Сейчас продолжается бум различных облачных решений.
Гипервизоры ESX и Hyper-V предлагают возможность создать снапшот виртуальной машины, который можно использовать для резервного копирования. Всё остальное можно бэкапить только используя встренные средства операционной системы.

Разброс дистрибутивов Linux так-же широк, а с ними и принципы разметки дискового пространства могут различаться.
Поэтому сервера без LVM разметки на дисках, или без BTRFS существуют. Более того, чтобы воспользоваться снапшотами dm-snap, нужно чтобы на сервере было зарезервировано свободное дисковое пространство без файловой системы. Судя по моему опыту, такая конфигурация является редкостью. У BTRFS есть сторонники и противники. Не буду вдаваться в подробности, это тема для отдельного "holy war".

Таким образом, значительная часть серверов остаются без снапшотов. Можно конечно заказчикам предлагать "Вот давайте обновите конфигурации всей вашей паре сотен серверов, чтобы оно соответсвовало требованиям нашего средства резервного копирования". Я сомневаюсь в успехе такого подхода.

### Надёжность

Сервер корпоративного пользователя должен работать 24/7. Остановка сервера на время бэкапа недопустима. И даже если в работе средства резервного копирования происходит сбой в работе, это не должно заметно влиять на работу сервера.

### Минимальное потребление системных ресурсов

Современные сервера могут похвастаться дисковым пространством в десятки терабайт. При этом очень желательно, чтобы резервное копирование успевало выполнится за ночь, во время минимальной нагрузки на инфраструктуру. Эта проблема решается наличием трекера изменений. Он позволяет создавать инкрементальный бэкап, перезачитывая только изменившиеся блоки.

### Минимальное время восстановления или репликации

Современное средство резервного копирования должно позволить восстановить всю IT инфраструктуру предприятия в минимальные сроки. Добиться этого можно только устранением человека из процесса восстановления. Хороший план восстановления, это когда у вас есть кнопочка "восстановить всё".

## Cоответствие требованиям

А теперь сравним, какие средства соответствуют перечисленным требованиям.

### BTRFS

Очевидно BTRFS не обладает средством универсальности. Но увы это не единственный его недостаток.

Есть проблемы с надёжностью. Если на файловой системе создан снапшот, а может быть даже два, то может возникнуть ситуация нехватки дискового пространства. В этом случае приложения пользователя получат отказ при попытке записи данных, а сервер окажется не способен более работать. Такая ситуация неприемлема для корпоративного пользователя.

Потребление системных ресурсов чрезмерное. Несмотря на то что BTRFS поддерживает [инкрементальные бэкапы](https://btrfs.wiki.kernel.org/index.php/Incremental_Backup), чтобы его использовать, придётся хранить на системе снапшот от предыдущей резервной копии. Это увеличивает потребность в дисковом пространстве. С учётом проблемы с надёжностью, дополнительное потребление дискового пространства может привести к печальным последствиям.

При восстановлении приходится создавать файловую систему заново и восстанавливать в ней файлы. Это снижает скорость восстановления.

### DM snapshot

DM снапшот может быть создан только для DM устройств, а значит что на диске должна быть LVM разметка. Поэтому свойством универсальности такое решение не обладает. Организация хранилища изменений имеет недостатки, так как требует заранее выделить свободное дисковое пространство и распределить его между всеми блочными устройствами, для которых создаётся снапшот.

Не обеспечивается минимизация потребления системных ресурсов при резервном копировании, так как при бэкапе приходится перечитывать весь снапшот.

Остальные требования обеспечиваются.

### Blksnap

Модуль blksnap позволяет обеспечить требование универсальности почти полностью, так как позволяет создавать снапшоты для любых блочных устройств, в том числе и для DM устройств вне зависимости от файловой системы. Однако есть сложности с восстановлением BTRFS из такой резервной копии. Не поддерживаются кластерные файловые системы.

Модуль позволяет организовать хранилище изменений на любом свободном дисковом пространстве и даже из блоков файлов на существующей файловой системе. Хранилище изменений является общим для всех блочных устройств, для которых создаётся образ. В результате, модуль может быть использован практически для любых серверов.

Высокая надёжность модуля blksnap обеспечивается алгоритмом COW. При перехвате запросов ввода/вывода, как и DM snapshot, в хранилище изменений копируются данные для отображения снапшота, а актуальные данные располагаются на своих местах. Такой алгоритм гарантирует, что данные пользователя останутся неповреждёнными, даже если при удержании снапшота произойдёт падение ядра.

Есть возможность расширять хранилище изменений динамически уже во время удержания снапшота. Однако, если свободного дискового пространства остаётся меньше допустимого предела, то хранилище изменений не может быть расширено. В результате возникает ситуация переполнения снапшота, что приводит к освобождению хранилища изменений. Конечно, процесс резервного копирования прерывается с ошибкой, но сервер продолжает работать.

Минимальное потребление системных ресурсов обеспечивает трекер изменений. Благодаря ему сокращается время резервного копирования, а значит и потребление электроэнергии.

Минимальное время восстановления возможно благодаря копированию блочных устройств целиком. В бэкап попадает вся система полностью, за исключением раздела SWAP и содержимого NVRAM. При ресторе остаётся только воссоздать таблицу разделов и восстановить содержимое разделов.

## Most popular questions

Если я вас смог убедить, что с имеющимися снапшотами для Linux что-то не так, то давайте попробуем ответить на самые популярные вопросы.

### Почему не DM?

Вы конечно скажете: "Зачем писать новый велосипед! Нужно всего-то доработать существующий! Дублирование же.". Честно признаться я тоже так думал...
Я пробовал пройти по [этому пути](https://lore.kernel.org/linux-block/1611853955-32167-1-git-send-email-sergei.shtepa@veeam.com/).

Чтобы двигаться в этом направлении нужна заинтересованность майнтейнера DM (и его работодателя, я полагаю). Требуется значительное изменение хорошо отлаженного кода. Требуется затраты на ревью, тестирование, исправление документации. Возможно появление неожиданных ошибок, наверняка это добавит новых кейсов от пользователей, а команде dm-devel@redhat.com придётся поддерживать новый функционал.
Я не смог продвинуться достаточно далеко в этом направлении, хотя мой прототип blk_interposer вполне неплохо работал на моей машине.
Я не один, кто пытался взаимодействовать с парнями DM по этому вопросу. Мне очень понравился [этот комментарий](https://lwn.net/Articles/914908/). Согласен с ним.
Для себя я решил, что DM и так достаточно хорош, чтобы пытаться делать его ещё лучше.

### А учитываются ли интересы других вендоров средств резервного копирования?

Ответ сразу и "да" и "нет".
С одной стороны Формально никаких договорённостей нет. Модуль blksnap это инициатива разработчика Veeam Software.
С другой стороны, я очень рад что к проекту присоединился Fabio Fantoni. Его советы позволяют взглянуть на некоторые вопросы с другой точки зрения. Поэтому, можно считать что интересы [M2Rbiz](https://github.com/M2Rbiz) учитываются.
Есть на github и открытое [средства резервного копирования](https://github.com/cloudbase/coriolis-snapshot-agent), которые уже используют модуль blksnap. Проект пока в стадии разработки, но я надеюсь, что у парней всё получится.
Модуль blksnap довольно подробно документирован, для него есть библиотеки, инструменты и тесты. Взгляните на проект [blksnap](https://github.com/veeam/blksnap/). Я уверен, что вендорам средств резервного копирования не составит труда поддержать работу своих продуктов с модулем blksnap. Поэтому, я считаю что их интересы учитываются.

### Вы протащите в ядро свою крюк в виде фильтра, а модуль в составе ядра окажется заброшенным?

Использование модуля из состава ядра позволит поднять качество обслуживания пользователей средств резервного копирования на новый уровень.
1. Существуют организации, политики безопасности которых, запрещаеют устанавливать out-of-tree модули ядра. Сейчас мы способны обеспечить работу нашего продукта на таких серверах с ограничением функционала. С модулем в составе ядра таких ограничений не будет.
2. Дистрибъютеры, которые предоставляют техническую поддержку своим пользователям, отказываются рассматривать кейсы падения ядра, если на системе обнаруживается out-of-tree модуль. С модулем в составе ядра пользователи гарантированно смогут получать техническую поддержку.
3. Гарантированная работа модуля при обновлении ядра из upstream и "франкенштейнов" от дистрибьюторов. Kernel API постоянно меняется, улучшается. Это конечно здорово, но в out-of-tree модуле это выглядит как нагромождение директив условной компиляции. Каждый релиз ядра upstream или ядра от дистрибьютера превращается в лотерею: соберётся или не соберётся, уронить ядро или нет. В случае обслуживания in-tree модуля, все изменения можно выполнить своевременно, обеспечить тестирование изменений, внести критические исправления ещё на этапе RC, а дистрибутеры будут распространять модуль, собранный с ядром, что избавит от проблем, например с KABI совместимостью таких как [эта](https://access.redhat.com/solutions/6985596).

## Заключение

Я уверен, что модуль для создания снапшотов блочных устройств в ядре Linux необходим. Надеюсь я смог убедить и вас в этом.
Любая помощь, совет или критика приветствуются.
С удовольствием отвечу на все ваши вопросы в комментариях.

Приветствуются публикации статьи с указанием автора и ссылки на первоисточник.
